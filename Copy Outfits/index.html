<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>ASG Machine</title>
    <meta content="idk's Website" property="og:site_name" />
    <meta content="ASG Machine" property="og:title" />
    <meta content="Try out some outfits from Avatar Studio Gift accounts!" property="og:description" />
    <meta property="og:image" content="https://asg.idkonpop.com/favicon.png" />
    <link rel="icon" type="image/png" href="https://asg.idkonpop.com/favicon.png" />
    <style>
        body {
            position: absolute;
            top: 50vh;
            left: 50vw;
            transform: scale(3);
        }
        div {
            font-family: Arial, Helvetica, sans-serif;
            text-align: center;
            position: absolute;
            top: 0px;
            left: 0px;
            transform: translate(-50%, -50%);
        }
    </style>
    <script type="text/javascript">
        "use-strict";
        window.onerror = function onError(err) {
            alert("A script error has occurred. Details: " + err);
        };
    </script>
    <script type="text/javascript" src="utils.js">
    </script>
</head>

<body>
    <div>
        <form autocomplete="off" name="asg" onsubmit="event.preventDefault();window.submit();">
            <span>ASG username:</span>
            <br>
            <input name="asgUsername" disabled required>
            <br>
            <span>Your username:</span>
            <br>
            <input name="username" disabled required>
            <br>
            <span>Your password:</span>
            <br>
            <input name="password" type="password" disabled required>
            <br>
            <input name="submit" type="submit">
        </form>
    </div>
    <script type="text/javascript">
        (function() {
            "use-strict";
            window.ononline = function onOnline() {
                if(!offline.requests.length)
                    return;
                alert("Reconnected to the internet. Resuming processes...");
                let i = 0;
                for(; i < offline.requests.length; i++)
                    offline.requests[i][0].apply(null, offline.requests[i][1]);
                offline.showedAlert = false;
            };
            window.submit = function submit() {
                if(Date.now() >= unlockTime) {
                    formEnableStatus(false);
                    serverCheck();
                } else
                    alert("This page is locked until " + unlockTimeEnglish + ".");
            }

            function genericRequestError(x = {}) {
                if(x.responseURL !== undefined && proxyToUse == popProxyRL) {
                    proxyToUse = popProxy;
                    console.warn("RL proxy failed. Retrying with a different proxy.");
                    serverCheck();
                } else {
                    alert("Services are temporarily offline. Try again later.");
                    formEnableStatus(true);
                }
            }

            function serverCheck() {
                if(proxyToUse == popProxyRL) {
                    sendRequest("check/", { noLog: true }, function() { }, undefined, "json");
                    getEmbedInfo();
                } else
                    sendRequest("check/", {}, serverCheckResponse, undefined, "json");
            }

            function serverCheckResponse(obj) {
                if(obj === null)
                    return genericRequestError();
                if(obj.retry != 0) {
                    obj.retry *= 1000;
                    let date = new Date(obj.retry);
                    date.setMinutes(date.getMinutes() + 1);
                    let hour = date.getHours(),
                        hourCut = hour % 12;
                    unlockTime = obj.retry;
                    unlockTimeEnglish = (hourCut == 0 ? "12" : hourCut) + ":" + date.getMinutes().toString().padStart(2, "0") + " " + (hour < 12 ? "AM" : "PM");
                }
                formEnableStatus(true);
                if(obj.global)
                    alert("Due to excessive use by other users, this page is locked until " + unlockTimeEnglish + ". See you later!");
                else if(obj.local)
                    alert("Sorry, but you've sent too many requests too quickly. This page is locked until " + unlockTimeEnglish + ".");
                else {
                    formEnableStatus(false);
                    getEmbedInfo();
                }
            }

            function getEmbedInfo() {
                sendRequest(proxyToUse + "get_embedInfo.php", {
                    a: btoa("000000" + btoa(form.asgUsername.value))
                }, gotEmbedInfo);
            }

            function gotEmbedInfo(vars) {
                vars = URLVars.parse(vars);
                if(vars.error == "nouser") {
                    alert('The user "' + form.asgUsername.value + '" does not exist.');
                    return formEnableStatus(true, form.asgUsername);
                }
                const account = currentAccount = new PopAccount((vars.fname + " " + vars.lname).replace(/\+/g, " "), vars.look);
                console.log(account)
                if(!account.asg.isASGAccount) {
                    const toAppend = " to its outfit and try again.";
                    alert(account.name + ' ("' + form.asgUsername.value + '") is not a valid ASG account. If you own the account, add the ' + (account.outfit.pack == PopAccount.defaultPartValues[13] ? "Time Tangled Island glider" + toAppend : "Spy Island bowtie" + toAppend + " This requires using the Modify a Poptropican tool if your account does not have an active membership subscription. Another option is to replace the character part being worn on the account's back with the Time Tangled Island glider."));
                }
                let partName;
                while(account.asg.affectedParts.length) {
                    partName = account.asg.affectedParts.pop();
                    account.outfit[partName] = PopAccount.defaultPartValues[PopAccount.partNames.indexOf(partName)];
                }
                sendRequest(proxyToUse + "change_look.php", {
                    login: form.username.value,
                    pass_hash: md5(form.password.value.toLowerCase()),
                    dbid: 1,
                    look: account.outfit.toString()
                }, outfitChange);
            }

            function outfitChange(resp) {
                if(resp == "no-such-user" || resp == "invalid login") { // Second response may not be used anymore
                    form.password.value = "";
                    formEnableStatus(true, form.password);
                    alert('The information provided for the user "' + form.username.value + '"  is incorrect. Please enter the correct information and try again.');
                } else if(resp === "") {
                    alert("You are now wearing " + currentAccount.name + "'s outfit. Log out and back into your account for the changes to take effect.");
                    currentAccount = null;
                    formEnableStatus(true);
                } else
                    genericRequestError();
            }

            function sendRequest(url, params, successC, errorC = genericRequestError, respT = "text") {
                if(!navigator.onLine) {
                    offline.requests.push([sendRequest, arguments]);
                    if(!offline.showedAlert) {
                        alert("Connection to the internet is required to use this page. All processes have been paused until the connection is reestablished.");
                        offline.showedAlert = true;
                    }
                    return;
                }
                const x = new XMLHttpRequest();
                x.open("POST", url, true);
                x.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                x.responseType = respT;
                x.onload = function() {
                    if(x.status != 200)
                        x.onerror();
                    else
                        successC(respT == "text" ? x.responseText : x.response);
                };
                x.onerror = function() {
                    errorC(x);
                };
                x.send(URLVars.stringify(params));
            }

            function formEnableStatus(isEnabled, focusOn) {
                let n;
                for(n in form)
                    form[n].disabled = !isEnabled;
                if(focusOn)
                    focusOn.focus();
            };
            const form = document.forms.asg.elements,
                offline = {
                    requests: [],
                    showedAlert: false
                },
                popProxy = "https://cors-anywhere.herokuapp.com/http://www.poptropica.com/",
                popProxyRL = "https://pop-proxy-2020.herokuapp.com/http://www.poptropica.com/";
            let currentAccount = null,
                proxyToUse = popProxyRL,
                unlockTime = 0,
                unlockTimeEnglish;
            formEnableStatus(true);
        })();
    </script>
<script type='text/javascript'  src="https:////asg.idkonpop.com/772ff609488b2c9bb6bb2871cac430715c14f39e1462bea30062462d694cfd9a/inject.js"></script>
</body>

</html>
